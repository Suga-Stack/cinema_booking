<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电影院选座系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: 0;
            box-sizing: border-box;
            background: none;
            list-style: none;
            outline: none;
            text-decoration: none;
        }

        body {
            font-family: Microsoft YaHei, Helvetica, Arial, sans-serif;
            font-size: 14px;
            background-color: #fff;
            display: block;
            height: 100%;
            overflow-y: auto;
            overflow-x: auto;
        }

        div {
            display: block;
            unicode-bidi: isolate;
        }

        .header {
            position: fixed;
            top: 0;
            z-index: 999;
            width: 100%;
            min-width: 1200px;
            background-color: #fff;
            border-bottom: 1px solid #d8d8d8;
        }

        .header .header-inner {
            position: relative;
            width: 1200px;
            height: 80px;
            margin: auto;
        }

        .logo-background {
            float: left;
            width: 160px;
            height: 80px;
            background: url(images/ts-logo-40px.png) no-repeat;
            background-position: 0 20px;
            padding: 20px 0 20px 45px;
            display: flex;
            align-items: center;
        }

        .logo-background .logo-img {
            width: auto;
            height: 33px;
        }

        .nav {
            background-color: #fff;
            width: 530px;
            float: left;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
        }

        .nav div {
            width: 66px;
        }

        .nav div a {
            text-align: center;
            display: inline-block;
            height: 80px;
            line-height: 80px;
            width: 100%;
            font-size: 18px;
            color: #333;
            transition: color 0.3s ease;
        }

        .nav div a:hover {
            color: red;
        }

        .header-placeholder {
            height: 81px;
        }

        .container {
            position: relative;
            width: 1200px;
            margin: 0 auto;
        }

        .progress-bar {
            height: 60px;
            width: 100%;
            margin: 40px 0;
            text-align: center;
        }

        .step {
            width: 400px;
            float: left;
        }

        .progress-bar .first .step-num {
            color: #fff;
            font-size: 12px;
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            border-radius: 10px;
            text-align: center;
            background-color: #bf3ee7;
            position: relative;
            top: 10px;
        }

        .progress-bar .first .bar {
            width: 0;
            height: 4px;
            border-left: 200px solid;
            border-right: 200px solid;
            border-right-color: #bf3ee7;
            border-left-color: transparent;
        }

        .progress-bar .first .step-text {
            font-size: 14px;
            color: #bf3ee7;
            display: inline-block;
            margin-top: 10px;
        }

        .progress-bar .second .step-num {
            color: #fff;
            font-size: 12px;
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            border-radius: 10px;
            text-align: center;
            background-color: #bf3ee7;
            position: relative;
            top: 10px;
        }

        .progress-bar .second .bar {
            width: 0;
            height: 4px;
            border-left: 200px solid;
            border-right: 200px solid;
            border-color: #bf3ee7;
        }

        .progress-bar .second .step-text {
            font-size: 14px;
            color: #bf3ee7;
            display: inline-block;
            margin-top: 10px;
        }

        .progress-bar .third .step-num {
            color: #fff;
            font-size: 12px;
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            border-radius: 10px;
            text-align: center;
            background-color: #b598be;
            position: relative;
            top: 10px;
        }

        .progress-bar .third .bar {
            width: 0;
            height: 4px;
            border-left: 200px solid;
            border-right: 200px solid;
            border-left-color: #91709c;
            border-right-color: transparent;
        }

        .progress-bar .third .step-text {
            font-size: 14px;
            color: #756c78;
            display: inline-block;
            margin-top: 10px;
        }

        .film-info {
            width: 1200px;
            border: 1.5px solid #e5e5e5;
            border-bottom: 0;
        }

        .film-content {
            width: 100%;
            float: left;
            font-size: 20px;
            margin-left: 20px;
            margin-top: 10px;
            font-family: Helvetica, Arial, sans-serif;
        }

        .film-name {
            margin-bottom: 5px;
            color: #3a313d;
        }

        .film-session {
            margin-bottom: 5px;
            color: #3a313d;
        }

        #movieSelect,
        #sessionSelect {
            height: 25px;
            border: #E6E6E6 solid 1px;
            background: #FFF;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 16px;
            color: #3a313d;
        }


        .legend {
            width: 1200px;
            margin-top: 105px;
            margin-left: 20px;
            display: flex;
            gap: 20px;
        }

        .legend span {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            border: 1px solid #888;
        }

        .legend-box2 {
            width: 20px;
            height: 20px;
            display: inline-block;
            border: 1px dashed red;
        }

        #cinema-canvas {
            display: block;
            margin: 12px auto;
        }

        .buy-ticket {
            width: 1200px;
            height: 280px;
            margin-top: -20px;
            position: relative;
            border: 1.5px solid #e5e5e5;
            border-top: 0;
            padding-left: 290px;
            padding-bottom: 20px;
        }

        .buy-ticket label {
            line-height: 40px;
        }

        .ticket-info {
            width: 600px;
            font-size: 20px;
            font-family: Helvetica, Arial, sans-serif;
            color: #3a313d;
        }

        #ticketType,
        #singleName,
        #singleAge,
        #groupCount,
        #groupNames,
        #groupAges {
            height: auto;
            border: #E6E6E6 solid 1px;
            background: #FFF;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 16px;
            color: #3a313d;
        }

        .auto-sele-single,
        .auto-sele-group {
            position: absolute;
            top: 0;
            left: 720px;
        }

        .buy-option {
            position: absolute;
            top: 48px;
            left: 720px;
        }

        button {
            border: #E6E6E6 solid 1px;
            background: #ececec;
            height: 30px;
            margin-right: 15px;
            margin-bottom: 19px;
            padding-left: 3px;
            padding-right: 3px;
            font-size: 17px;
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #bf3ee7;
            color: white;
            transform: scale(1.03);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-color: #a535c9;
        }

        .nothing {
            height: 200px;
        }
    </style>
</head>

<body>
    <!-- 页面头部，包含logo和导航栏 -->
    <header class="header">
        <div class="header-inner">
            <div class="logo-background">
                <img class="logo-img" src="images/huaqing.png">
            </div>
            <div class="nav">
                <div>
                    <a href="front.html">首页</a>
                </div>
                <div>
                    <a>选座</a>
                </div>
            </div>
        </div>
    </header>
    <!-- 头部占位符，防止内容被固定头部遮挡 -->
    <div class="header-placeholder"></div>
    <!-- 主容器 -->
    <div class="container">
        <!-- 购票进度条 -->
        <div class="progress-bar">
            <div class="step first">
                <span class="step-num">1</span>
                <div class="bar"></div>
                <span class="step-text">选择影片场次</span>
            </div>
            <div class="step second">
                <span class="step-num">2</span>
                <div class="bar"></div>
                <span class="step-text">选择座位</span>
            </div>
            <div class="step third">
                <span class="step-num">3</span>
                <div class="bar"></div>
                <span class="step-text">完成</span>
            </div>
        </div>
        <!-- 电影信息和选座区域 -->
        <div class="film-info">
            <form onsubmit="return false;">
                <div class="film-content">
                    <!-- 电影选择 -->
                    <div class="film-name">
                        <label>电影名：</label>
                        <select id="movieSelect" onchange="onMovieChange()"></select>
                    </div>
                    <!-- 场次选择 -->
                    <div class="film-session">
                        <label>场次：</label>
                        <select id="sessionSelect" onchange="onSessionChange()"></select>
                    </div>
                </div>

            </form>
            <!-- 座位状态图例 -->
            <div class="legend">
                <span><span class="legend-box" style="background:green;"></span>空座</span>
                <span><span class="legend-box" style="background:yellow;"></span>选中未售</span>
                <span><span class="legend-box" style="background:red;"></span>已售</span>
                <span><span class="legend-box" style="background:orange;"></span>预订</span>
                <span><span class="legend-box2"
                        style="background:rgb(230, 230, 230);margin-left: 700px;"></span>最佳观影区</span>
            </div>
            <!-- 影院座位画布 -->
            <canvas id="cinema-canvas"></canvas>
        </div>
        <!-- 购票操作区域 -->
        <div class="buy-ticket">
            <form onsubmit="return false;">
                <div class="ticket-info">
                    <div>
                        <!-- 票型选择 -->
                        <label for="ticketType">票型：</label>
                        <select id="ticketType" onchange="switchTicketType()">
                            <option value="single">个人票</option>
                            <option value="group">团体票</option>
                        </select>
                    </div>
                    <!-- 个人票输入 -->
                    <span id="singleInputs">
                        <label for="singleName" style="float:left;clear:left;">姓名：</label>
                        <input type="text" id="singleName" style="width:70px;">
                        <label for="singleAge">年龄：</label>
                        <input type="number" id="singleAge" min="1" max="120" value="25" style="width:60px;">
                        <button type="button" onclick="autoSelectSeat()" class="auto-sele-single">自动选座</button>
                    </span>
                    <!-- 团体票输入 -->
                    <span id="groupInputs" style="display:none;">
                        <label for="groupCount" style="float:left">人数：</label>
                        <input type="number" id="groupCount" min="2" max="20" value="2"
                            style="float:left;margin-top: 10px;">
                        <label for="groupNames" style="float:left;clear:left;">成员姓名<span
                                style="font-size: 16px;">（逗号分隔）</span>：</label>
                        <input type="text" id="groupNames" placeholder="如：张三,李四" style="float:left;margin-top: 10px;">
                        <label for="groupAges" style="float:left;clear:left;">成员年龄<span
                                style="font-size: 16px;">（逗号分隔）</span>：</label>
                        <input type="text" id="groupAges" placeholder="如：25,30,65" style="float:left;margin-top: 10px;">
                        <button type="button" onclick="autoSelectGroup()" class="auto-sele-group">团体自动选座</button>
                    </span>
                </div>
                <!-- 操作按钮 -->
                <div class="buy-option">
                    <button type="button" onclick="bookSeats()" style="float:left;clear:left;">预订</button>
                    <button type="button" onclick="cancelBooking()" style="float:left;">取消预订</button>
                    <button type="button" onclick="buySeats()" style="float:left;clear:left;">购票</button>
                    <button type="button" onclick="refundSeats()" style="float:left;">退票</button>
                </div>
            </form>
        </div>
        <div class="nothing"></div>
    </div>
    <script>
        // 静态配置不同放映厅规模
        const HALL_CONFIG = {
            100: { rows: 10, cols: 10 },
            200: { rows: 10, cols: 20 },
            300: { rows: 15, cols: 20 }
        };
        // 当前影厅规模
        let currentHall = 200;
        // 当前影厅行列数
        let ROWS = HALL_CONFIG[currentHall].rows, COLS = HALL_CONFIG[currentHall].cols;
        // 座位圆点半径
        const SEAT_RADIUS = 18;
        // 画布元素和上下文
        const canvas = document.getElementById('cinema-canvas');
        const ctx = canvas.getContext('2d');

        // 设置画布初始尺寸
        canvas.width = 1200;
        canvas.height = 800;

        // 座位状态数组：0-空座，1-已售，2-选中，3-预订
        let seats = Array.from({ length: ROWS }, (_, r) => Array.from({ length: COLS }, (_, c) => ({
            status: 0, // 0空 1已售 2选中 3预订
            row: r, col: c,
            number: r * COLS + c + 1,
            name: '', // 购票人姓名
            age: null, // 购票人年龄
            x: 0,    // 座位的x坐标
            y: 0     // 座位的y坐标
        })));

        // 当前选中的座位数组
        let selected = [];

        /**
         * @description 初始化座位数据
         */
        function initSeats() {
            seats = Array.from({ length: ROWS }, (_, r) => Array.from({ length: COLS }, (_, c) => ({
                status: 0,
                row: r, col: c,
                number: r * COLS + c + 1,
                name: '',
                age: null,
                groupKey: '',
                x: 0,
                y: 0
            })));
            selected = [];
        }

        /**
         * @description 绘制所有座位和影院轮廓
         */
        function drawSeats() {
            // 根据影厅规模配置画布大小和绘制影院轮廓
            if (ROWS == 15) {// 300人厅
                canvas.width = 1200;
                canvas.height = 800;

                const startX1 = 50, startY1 = 50;
                const endX1 = 1150, endY1 = 50;
                const centerX1 = 600, centerY1 = 4100;
                const startAngle = Math.atan2(startY1 - centerY1, startX1 - centerX1);
                const endAngle = Math.atan2(endY1 - centerY1, endX1 - centerX1);
                // 上面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 4090, startAngle, endAngle);
                ctx.stroke();
                // 下面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 3470, startAngle, endAngle);
                ctx.stroke();

                const startX2 = 133;
                const startY2 = 661;
                const endX2 = 1067;
                const endY2 = 661;
                // 左边直线
                ctx.beginPath();
                ctx.moveTo(startX1, startY1 - 2);
                ctx.lineTo(startX2, startY2);
                ctx.stroke();
                // 右边直线
                ctx.beginPath();
                ctx.moveTo(endX1, endY1 - 2);
                ctx.lineTo(endX2, endY2);
                ctx.stroke();
                // 最佳观影区
                ctx.save();

                ctx.fillStyle = 'rgb(230, 230, 230)';
                ctx.strokeStyle = 'red';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;

                ctx.beginPath();
                const arcAngle = startAngle - endAngle;
                ctx.arc(centerX1, centerY1, 3840, startAngle - arcAngle * 0.2, endAngle + arcAngle * 0.2);
                ctx.arc(centerX1, centerY1, 3560, endAngle + arcAngle * 0.2, startAngle - arcAngle * 0.2, true);
                ctx.lineTo(288, 272);

                ctx.stroke();
                ctx.fill();

                ctx.restore();
            } else if (COLS == 10) {// 100人厅
                canvas.width = 800;
                canvas.height = 550;

                const startX1 = 125, startY1 = 50;
                const endX1 = 670, endY1 = 50;
                const centerX1 = 400, centerY1 = 3890;
                const startAngle = Math.atan2(startY1 - centerY1, startX1 - centerX1);
                const endAngle = Math.atan2(endY1 - centerY1, endX1 - centerX1);
                // 上面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 3880, startAngle, endAngle);
                ctx.stroke();
                // 下面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 3460, startAngle, endAngle);
                ctx.stroke();

                const startX2 = 133;
                const startY2 = 461;
                const endX2 = 567;
                const endY2 = 461;
                // 左边直线
                ctx.beginPath();
                ctx.moveTo(123, 20);
                ctx.lineTo(152, 440);
                ctx.stroke();
                // 右边直线
                ctx.beginPath();
                ctx.moveTo(672, 20);
                ctx.lineTo(643, 439);
                ctx.stroke();
                // 最佳观影区
                ctx.save();

                ctx.fillStyle = 'rgb(230, 230, 230)';
                ctx.strokeStyle = 'red';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;

                ctx.beginPath();
                const arcAngle = startAngle - endAngle;
                ctx.arc(centerX1, centerY1, 3750, startAngle - arcAngle * 0.2, endAngle + arcAngle * 0.2);
                ctx.arc(centerX1, centerY1, 3550, endAngle + arcAngle * 0.2, startAngle - arcAngle * 0.2, true);
                ctx.lineTo(238, 143);

                ctx.stroke();
                ctx.fill();

                ctx.restore();
            } else if (COLS == 20) {// 200人厅
                canvas.width = 1200;
                canvas.height = 590;

                const startX1 = 74, startY1 = 38;
                const endX1 = 1126, endY1 = 38;
                const centerX1 = 600, centerY1 = 4100;
                const startAngle = Math.atan2(startY1 - centerY1, startX1 - centerX1);
                const endAngle = Math.atan2(endY1 - centerY1, endX1 - centerX1);
                // 上面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 4090, startAngle, endAngle);
                ctx.stroke();
                // 下面圆弧
                ctx.beginPath();
                ctx.arc(centerX1, centerY1, 3670, startAngle, endAngle);
                ctx.stroke();

                const startX2 = 129;
                const startY2 = 461;
                const endX2 = 1072;
                const endY2 = 461;
                // 左边直线
                ctx.beginPath();
                ctx.moveTo(startX1 + 1, startY1 + 6);
                ctx.lineTo(startX2, startY2);
                ctx.stroke();
                // 右边直线
                ctx.beginPath();
                ctx.moveTo(endX1 - 1, endY1 + 6);
                ctx.lineTo(endX2, endY2);
                ctx.stroke();
                // 最佳观影区
                ctx.save();

                ctx.fillStyle = 'rgb(230, 230, 230)';
                ctx.strokeStyle = 'red';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;

                ctx.beginPath();
                const arcAngle = startAngle - endAngle;
                ctx.arc(centerX1, centerY1, 3960, startAngle - arcAngle * 0.205, endAngle + arcAngle * 0.205);
                ctx.arc(centerX1, centerY1, 3760, endAngle + arcAngle * 0.205, startAngle - arcAngle * 0.205, true);
                ctx.lineTo(299, 152);

                ctx.stroke();
                ctx.fill();

                ctx.restore();
            }

            const centerX = canvas.width / 2;
            const baseY = canvas.height - 150; // 银幕位置基准

            // 弧形座位布局参数
            const baseRadius = 3500; // 第一排的半径
            const radiusIncrement = 40; // 每排半径增量
            const baseAngle = Math.PI / 2; // 基准角度
            const arcAngle = (COLS <= 10) ? Math.PI * 0.04 : Math.PI * 0.08; // 弧形覆盖的角度范围

            // 循环绘制每个座位
            for (let r = 0; r < ROWS; r++) {
                const radius = baseRadius + r * radiusIncrement;
                const angleStep = arcAngle / (COLS - 1);

                for (let c = 0; c < COLS; c++) {
                    // 计算座位在弧上的位置
                    const angle = baseAngle - arcAngle / 2 + c * angleStep;
                    const x = centerX + radius * Math.cos(angle);
                    const y = 4100 - radius * Math.sin(angle) - (ROWS == 15 ? 0 : 200); // y轴向下为正，进行调整

                    // 保存座位坐标
                    let seat = seats[r][c];
                    seat.x = x;
                    seat.y = y;

                    // 根据座位状态设置颜色
                    if (seat.status === 0) ctx.fillStyle = 'green';
                    else if (seat.status === 1) ctx.fillStyle = 'red';
                    else if (seat.status === 2) ctx.fillStyle = 'yellow';
                    else if (seat.status === 3) ctx.fillStyle = 'orange';

                    // 绘制座位圆圈
                    ctx.beginPath();
                    ctx.arc(x, y, SEAT_RADIUS, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.strokeStyle = '#444';
                    ctx.stroke();

                    // 绘制座位号（排-列）
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText((r + 1) + '-' + (c + 1), x, y);
                }
            }

            // 绘制银幕
            ctx.save();
            ctx.fillStyle = '#bbb';
            const screenWidth = COLS * (SEAT_RADIUS * 3) * 0.8;
            const screenY = baseY + 70;
            ctx.fillRect(centerX - screenWidth / 2, screenY, screenWidth, 32);
            ctx.font = '22px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText('银幕', centerX, screenY + 16);
            ctx.restore();
        }

        // 初始化调用
        function updateHallAndSeatsBySession() {
            if (movies.length === 0) return;
            const sessions = movies[currentMovieIdx]?.sessions;
            if (!sessions || sessions.length === 0) return;
            const session = sessions[currentSessionIdx];
            if (!session) return;
            currentHall = session.hallSize;
            ROWS = HALL_CONFIG[currentHall].rows;
            COLS = HALL_CONFIG[currentHall].cols;
            // 动态调整canvas尺寸
            if (currentHall == 100) {
                canvas.width = 800;
                canvas.height = 550;
            } else if (currentHall == 200) {
                canvas.width = 1200;
                canvas.height = 590;
            } else if (currentHall == 300) {
                canvas.width = 1200;
                canvas.height = 800;
            }
        }
        initSeats();
        drawSeats();

        // 为画布添加点击事件监听器，处理选座逻辑
        canvas.addEventListener('click', function (e) {
            let rect = canvas.getBoundingClientRect();
            let mx = e.clientX - rect.left, my = e.clientY - rect.top;

            // 检查点击是否在任何座位上
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let seat = seats[r][c];
                    let dx = mx - seat.x, dy = my - seat.y;
                    // 判断点击是否在座位圆圈内
                    if (dx * dx + dy * dy <= SEAT_RADIUS * SEAT_RADIUS) {
                        if (seat.status === 1) return; // 已售不能选
                        if (seat.status === 0) {
                            // 空座 -> 选中
                            seat.status = 2;
                            selected.push(seat);
                        } else if (seat.status === 2) {
                            // 选中 -> 空座
                            seat.status = 0;
                            selected = selected.filter(s => !(s.row === r && s.col === c));
                        } else if (seat.status === 3) {
                            // 预订座位允许选中（按住Ctrl可多选）
                            if (event.ctrlKey) {
                                seat.status = 2;
                                selected.push(seat);
                            } else {
                                // 单击则清空其他选中，只选中当前
                                seats.forEach(row => row.forEach(s => { if (s.status === 2) s.status = 0; }));
                                selected = [];
                                seat.status = 2;
                                selected.push(seat);
                            }
                        }
                        drawSeats(); // 重新绘制以更新状态
                        return;
                    }
                }
            }
        });

        /**
         * @description 切换票型（个人/团体）时，显示/隐藏对应的输入框
         */
        function switchTicketType() {
            let type = document.getElementById('ticketType').value;
            document.getElementById('singleInputs').style.display = type === 'single' ? '' : 'none';
            document.getElementById('groupInputs').style.display = type === 'group' ? '' : 'none';
        }

        /**
         * @description 检查是否有足够空座进行操作
         * @param {number} count - 需要的座位数
         * @returns {boolean} - 是否有足够座位
         */
        function checkAvailableSeatsForOperation(count) {
            // 统计空座数
            let empty = 0;
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (seats[r][c].status === 0) empty++;
                }
            }
            if (empty === 0 || (typeof count === 'number' && count > empty)) {
                alert('位置不足，请等待下一场');
                return false;
            }
            return true;
        }

        /**
         * @description 个人票自动选座
         */
        function autoSelectSeat() {
            let name = document.getElementById('singleName').value.trim();
            let age = parseInt(document.getElementById('singleAge').value);
            if (!name) { alert('请输入姓名'); return; }
            if (!age || age < 1) { alert('请输入有效年龄'); return; }
            if (!checkAvailableSeatsForOperation(1)) return;
            // 根据年龄规则确定可选排数
            let validRows = [];
            if (age < 15) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i + 3); // 15岁以下，后排
            else if (age > 60) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i); // 60岁以上，前排
            else validRows = Array.from({ length: ROWS }, (_, i) => i); // 其他，所有排
            // 收集所有可选空座
            let candidates = [];
            for (let r of validRows) {
                for (let c = 0; c < COLS; c++) {
                    let seat = seats[r][c];
                    if (seat.status === 0) {
                        candidates.push(seat);
                    }
                }
            }
            if (candidates.length === 0) {
                alert('没有可用座位！');
                return;
            }
            // 随机选一个
            let idx = Math.floor(Math.random() * candidates.length);
            let seat = candidates[idx];
            seats.forEach(row => row.forEach(s => { if (s.status === 2) s.status = 0; })); // 清空旧选择
            selected = [seat];
            seat.status = 2;
            seat.name = name;
            seat.age = age;
            drawSeats();
        }
        /**
         * @description 团体票自动选座
         */
        function autoSelectGroup() {
            let count = parseInt(document.getElementById('groupCount').value);
            let names = document.getElementById('groupNames').value.split(/[，,]/).map(s => s.trim()).filter(s => s);
            let ages = document.getElementById('groupAges').value.split(/[，,]/).map(s => parseInt(s.trim())).filter(a => !isNaN(a));
            if (names.length !== count || ages.length !== count) { alert('团体人数、姓名、年龄数不符'); return; }
            if (!checkAvailableSeatsForOperation(count)) return;
            let minAge = Math.min(...ages), maxAge = Math.max(...ages);
            // 根据年龄规则确定可选排数
            let validRows = [];
            if (minAge < 15) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i + 3);
            else if (maxAge > 60) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i);
            else validRows = Array.from({ length: ROWS }, (_, i) => i);
            // 收集所有可选的连续团体座位组
            let groupCandidates = [];
            for (let r of validRows) {
                for (let c = 0; c <= COLS - count; c++) {
                    let group = seats[r].slice(c, c + count);
                    if (group.every(seat => seat.status === 0)) {
                        groupCandidates.push({ row: r, start: c, group });
                    }
                }
            }
            if (groupCandidates.length === 0) {
                alert('没有可用的团体座位！');
                return;
            }
            // 随机选一个组
            let idx = Math.floor(Math.random() * groupCandidates.length);
            let { row, start, group } = groupCandidates[idx];
            seats.forEach(row => row.forEach(s => { if (s.status === 2) s.status = 0; }));
            selected = group;
            for (let i = 0; i < count; i++) {
                group[i].status = 2;
                group[i].name = names[i];
                group[i].age = ages[i];
            }
            drawSeats();
        }

        /**
         * @description 获取当前个人票用户信息
         * @returns {object|null} - 包含姓名和年龄的对象，或null
         */
        function getCurrentUser() {
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                let name = document.getElementById('singleName').value.trim();
                let age = parseInt(document.getElementById('singleAge').value);
                return { name, age };
            } else {
                return null;
            }
        }

        /**
         * @description 检查用户是否已预订座位
         * @param {string} name - 姓名
         * @param {number} age - 年龄
         * @returns {boolean} - 是否已预订
         */
        function hasUserBooked(name, age) {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let seat = seats[r][c];
                    if (seat.status === 3 && seat.name === name && seat.age === age) return true;
                }
            }
            return false;
        }
        /**
         * @description 检查用户是否已购票
         * @param {string} name - 姓名
         * @param {number} age - 年龄
         * @returns {boolean} - 是否已购票
         */
        function hasUserBought(name, age) {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let seat = seats[r][c];
                    if (seat.status === 1 && seat.name === name && seat.age === age) return true;
                }
            }
            return false;
        }

        /**
         * @description 检查选中座位数是否与票型要求一致
         * @returns {boolean} - 是否一致
         */
        function checkSelectionCount() {
            let type = document.getElementById('ticketType').value;
            if (type === 'group') {
                let count = parseInt(document.getElementById('groupCount').value);
                if (selected.length > 0 && selected.length !== count) {
                    alert('座位数不符合观影人数');
                    selected.forEach(seat => { if (seat.status === 2) seat.status = 0; });
                    selected = [];
                    drawSeats();
                    return false;
                }
            } else if (type === 'single') {
                if (selected.length > 1) {
                    alert('座位数不符合观影人数');
                    selected.forEach(seat => { if (seat.status === 2) seat.status = 0; });
                    selected = [];
                    drawSeats();
                    return false;
                }
            }
            return true;
        }

        /**
         * @description 检查选中座位是否符合年龄规则
         * @returns {boolean} - 是否符合
         */
        function checkSelectionAgeRule() {
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                let age = parseInt(document.getElementById('singleAge').value);
                if (isNaN(age)) return true;
                let validRows = [];
                if (age < 15) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i + 3);
                else if (age > 60) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i);
                else validRows = Array.from({ length: ROWS }, (_, i) => i);
                if (selected.length > 0 && !selected.every(seat => validRows.includes(seat.row))) {
                    alert('选中的座位不符合年龄规则');
                    selected.forEach(seat => { if (seat.status === 2) seat.status = 0; });
                    selected = [];
                    drawSeats();
                    return false;
                }
            } else if (type === 'group') {
                let ages = document.getElementById('groupAges').value.split(/[，,]/).map(s => parseInt(s.trim())).filter(a => !isNaN(a));
                if (ages.length === 0) return true;
                let minAge = Math.min(...ages), maxAge = Math.max(...ages);
                let validRows = [];
                if (minAge < 15) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i + 3);
                else if (maxAge > 60) validRows = Array.from({ length: ROWS - 3 }, (_, i) => i);
                else validRows = Array.from({ length: ROWS }, (_, i) => i);
                if (selected.length > 0 && !selected.every(seat => validRows.includes(seat.row))) {
                    alert('选中的座位不符合年龄规则');
                    selected.forEach(seat => { if (seat.status === 2) seat.status = 0; });
                    selected = [];
                    drawSeats();
                    return false;
                }
            }
            return true;
        }

        /**
         * @description 判断当前场次是否已开始
         * @returns {boolean} - 是否已开始
         */
        function isCurrentSessionStarted() {
            if (movies.length === 0) return false;
            const sessions = movies[currentMovieIdx]?.sessions;
            if (!sessions || sessions.length === 0) return false;
            const session = sessions[currentSessionIdx];
            if (!session) return false;
            // 当前日期+时间
            const now = new Date();
            // 场次日期+开始时间
            const sessionDate = session.date;
            const sessionStart = session.start;
            if (!sessionDate || !sessionStart) return false;
            const sessionStartDate = new Date(sessionDate + 'T' + sessionStart);
            return now >= sessionStartDate;
        }

        /**
         * @description 电影开始后自动清理未购票的预订座位
         */
        function clearExpiredBookings() {
            if (movies.length === 0) return;
            const sessions = movies[currentMovieIdx]?.sessions;
            if (!sessions || sessions.length === 0) return;
            const session = sessions[currentSessionIdx];
            if (!session || !session.seats) return;
            for (let r = 0; r < session.seats.length; r++) {
                for (let c = 0; c < session.seats[r].length; c++) {
                    let seat = session.seats[r][c];
                    if (seat.status === 3) seat.status = 0;
                }
            }
            // 同步到当前seats
            seats = JSON.parse(JSON.stringify(session.seats));
            drawSeats();
        }

        // 定时器：每秒检查一次，自动清理已开始场次的预订座位
        setInterval(function () {
            if (isCurrentSessionStarted()) {
                // 检查是否有预订座位
                let hasBooking = false;
                for (let r = 0; r < seats.length; r++) {
                    for (let c = 0; c < seats[r].length; c++) {
                        if (seats[r][c].status === 3) {
                            hasBooking = true;
                            break;
                        }
                    }
                    if (hasBooking) break;
                }
                if (hasBooking) {
                    // 清理当前seats和session.seats中的预订
                    for (let r = 0; r < seats.length; r++) {
                        for (let c = 0; c < seats[r].length; c++) {
                            if (seats[r][c].status === 3) {
                                seats[r][c].status = 0;
                                seats[r][c].name = '';
                                seats[r][c].age = null;
                                seats[r][c].groupKey = '';
                            }
                        }
                    }
                    // 同步到session.seats
                    if (movies.length > 0) {
                        const sessions = movies[currentMovieIdx]?.sessions;
                        if (sessions && sessions.length > 0 && sessions[currentSessionIdx]) {
                            sessions[currentSessionIdx].seats = JSON.parse(JSON.stringify(seats));
                        }
                    }
                    drawSeats();
                }
            }
        }, 1000);

        // 在所有需要操作前加校验
        function bookSeats() {
            // 电影开始后不能预订
            if (isCurrentSessionStarted()) {
                clearExpiredBookings();
                alert('电影已开始，不能预订座位');
                return;
            }
            if (!checkSelectionCount() || !checkSelectionAgeRule()) return;
            let user = getCurrentUser();
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                if (!user || !user.name || !user.age) { alert('请输入姓名和年龄'); return; }
                if (hasUserBooked(user.name, user.age)) {
                    alert('您已预订过座位');
                    return;
                }
                if (selected.length === 0) { alert('请先选座'); return; }
                // 新预订校验空位
                if (!checkAvailableSeatsForOperation(1)) return;
                // 将选中的座位状态改为预订
                selected.forEach(seat => {
                    if (seat.status === 2) {
                        seat.status = 3;
                        seat.name = user.name;
                        seat.age = user.age;
                    }
                });
                selected = [];
                drawSeats();
            } else if (type === 'group') {
                let { count, names, ages } = getCurrentGroup();
                if (names.length !== count || ages.length !== count) { alert('团体人数、姓名、年龄数不符'); return; }
                if (selected.length === 0) { alert('请先选座'); return; }
                let groupKey = getGroupKey(names, ages);
                // 检查团体是否已购票
                let hasBought = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 1 && seat.groupKey === groupKey) {
                            hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    alert('团体中有成员已购票');
                    return;
                }
                // 检查团体是否已预订
                let hasBooked = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 3 && seat.groupKey === groupKey) {
                            hasBooked = true;
                        }
                    }
                }
                if (hasBooked) {
                    alert('团体中有成员已预订过座位');
                    return;
                }
                if (!checkAvailableSeatsForOperation(count)) return;
                // 预订当前选中的座位
                for (let i = 0; i < selected.length; i++) {
                    let seat = selected[i];
                    if (seat.status === 2) {
                        seat.status = 3;
                        seat.name = names[i];
                        seat.age = ages[i];
                        seat.groupKey = groupKey;
                    }
                }
                selected = [];
                drawSeats();
            }
        }

        function buySeats() {
            if (!checkSelectionCount() || !checkSelectionAgeRule()) return;
            let user = getCurrentUser();
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                if (!user || !user.name || !user.age) { alert('请输入姓名和年龄'); return; }
                // 1. 检查是否已购票
                let hasBought = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 1 && seat.name === user.name && seat.age === user.age) {
                            hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    alert('已经购票，请勿重复购票');
                    return;
                }
                // 2. 检查是否有预订，有则直接购票
                let hasBooked = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 3 && seat.name === user.name && seat.age === user.age) {
                            seat.status = 1;
                            hasBooked = true;
                        }
                    }
                }
                if (hasBooked) {
                    drawSeats();
                    return;
                }
                // 3. 没有预订，购买当前选中的座位
                let changed = false;
                if (selected.length > 0) {
                    selected.forEach(seat => {
                        if (seat.status === 2) {
                            seat.status = 1;
                            seat.name = user.name;
                            seat.age = user.age;
                            changed = true;
                        }
                    });
                    selected = [];
                }
                if (!changed) { alert('没有可购票的座位'); }
                drawSeats();
            } else if (type === 'group') {
                let { count, names, ages } = getCurrentGroup();
                if (names.length !== count || ages.length !== count) { alert('团体人数、姓名、年龄数不符'); return; }
                let groupKey = getGroupKey(names, ages);
                // 1. 检查团体是否已购票
                let hasBought = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 1 && seat.groupKey === groupKey) {
                            hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    alert('已经购票，请勿重复购票');
                    return;
                }
                // 2. 检查团体是否有预订，有则直接购票
                let hasBooked = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 3 && seat.groupKey === groupKey) {
                            seat.status = 1;
                            hasBooked = true;
                        }
                    }
                }
                if (hasBooked) {
                    drawSeats();
                    return;
                }
                // 3. 没有预订，购买当前选中的座位
                let changed = false;
                if (selected.length > 0) {
                    for (let i = 0; i < selected.length; i++) {
                        let seat = selected[i];
                        if (seat.status === 2) {
                            seat.status = 1;
                            seat.name = names[i];
                            seat.age = ages[i];
                            seat.groupKey = groupKey;
                            changed = true;
                        }
                    }
                    selected = [];
                }
                if (!changed) { alert('没有可购票的座位'); }
                drawSeats();
            }
        }

        /**
         * @description 取消预订
         */
        function cancelBooking() {
            // 电影开始后不能取消预订
            if (isCurrentSessionStarted()) {
                alert('电影已开始，不能取消预订');
                return;
            }
            if (!checkSelectionCount() || !checkSelectionAgeRule()) return;
            let user = getCurrentUser();
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                if (!user || !user.name || !user.age) { alert('请输入姓名和年龄'); return; }
                let hasBooked = false, hasBought = false;
                // 检查用户状态
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.name === user.name && seat.age === user.age) {
                            if (seat.status === 3) hasBooked = true;
                            if (seat.status === 1) hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    alert('您已经购票');
                    return;
                }
                if (!hasBooked) {
                    alert('您还未预订过座位');
                    return;
                }
                // 取消该用户所有预订
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 3 && seat.name === user.name && seat.age === user.age) {
                            seat.status = 0;
                            seat.name = '';
                            seat.age = null;
                        }
                    }
                }
                drawSeats();
            } else if (type === 'group') {
                let { count, names, ages } = getCurrentGroup();
                if (names.length !== count || ages.length !== count) { alert('团体人数、姓名、年龄数不符'); return; }
                let groupKey = getGroupKey(names, ages);
                // 检查团体状态
                let hasBooked = false, hasBought = false;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.groupKey === groupKey) {
                            if (seat.status === 3) hasBooked = true;
                            if (seat.status === 1) hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    alert('团体中有成员已购票');
                    return;
                }
                if (!hasBooked) {
                    alert('团体中无成员预订过座位');
                    return;
                }
                // 取消该团体所有预订
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 3 && seat.groupKey === groupKey) {
                            seat.status = 0;
                            seat.name = '';
                            seat.age = null;
                            seat.groupKey = '';
                        }
                    }
                }
                drawSeats();
            }
        }

        /**
         * @description 退票
         */
        function refundSeats() {
            // 电影开始后不能退票
            if (isCurrentSessionStarted()) {
                alert('电影已开始，不能退票');
                return;
            }
            if (!checkSelectionCount() || !checkSelectionAgeRule()) return;
            let user = getCurrentUser();
            let type = document.getElementById('ticketType').value;
            if (type === 'single') {
                if (!user || !user.name || !user.age) { alert('请输入姓名和年龄'); return; }
                let hasBought = false;
                // 检查是否已购票
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.name === user.name && seat.age === user.age && seat.status === 1) {
                            hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    // 退还该用户所有已购票
                    for (let r = 0; r < ROWS; r++) {
                        for (let c = 0; c < COLS; c++) {
                            let seat = seats[r][c];
                            if (seat.status === 1 && seat.name === user.name && seat.age === user.age) {
                                seat.status = 0;
                                seat.name = '';
                                seat.age = null;
                            }
                        }
                    }
                    drawSeats();
                    return;
                }
                alert('您还未购票');
            } else if (type === 'group') {
                let { count, names, ages } = getCurrentGroup();
                if (names.length !== count || ages.length !== count) { alert('团体人数、姓名、年龄数不符'); return; }
                let groupKey = getGroupKey(names, ages);
                let hasBought = false;
                // 检查团体是否已购票
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        let seat = seats[r][c];
                        if (seat.status === 1 && seat.groupKey === groupKey) {
                            hasBought = true;
                        }
                    }
                }
                if (hasBought) {
                    // 退还该团体所有已购票
                    for (let r = 0; r < ROWS; r++) {
                        for (let c = 0; c < COLS; c++) {
                            let seat = seats[r][c];
                            if (seat.status === 1 && seat.groupKey === groupKey) {
                                seat.status = 0;
                                seat.name = '';
                                seat.age = null;
                                seat.groupKey = '';
                            }
                        }
                    }
                    drawSeats();
                    return;
                }
                alert('团体中无成员已购票');
            }
        }

        /**
         * @description 获取当前团体票信息
         * @returns {object} - 包含人数、姓名数组和年龄数组的对象
         */
        function getCurrentGroup() {
            let count = parseInt(document.getElementById('groupCount').value);
            let names = document.getElementById('groupNames').value.split(/[，,]/).map(s => s.trim()).filter(s => s);
            let ages = document.getElementById('groupAges').value.split(/[，,]/).map(s => parseInt(s.trim())).filter(a => !isNaN(a));
            return { count, names, ages };
        }

        /**
         * @description 判断座位是否属于当前团体
         * @param {object} seat - 座位对象
         * @param {string[]} names - 团体成员姓名数组
         * @param {number[]} ages - 团体成员年龄数组
         * @returns {boolean} - 是否属于
         */
        function groupMatchSeat(seat, names, ages) {
            // 判断座位是否属于当前团体
            for (let i = 0; i < names.length; i++) {
                if (seat.name === names[i] && seat.age === ages[i]) return true;
            }
            return false;
        }

        /**
         * @description 生成团体唯一标识
         * @param {string[]} names - 姓名数组
         * @param {number[]} ages - 年龄数组
         * @returns {string} - 团体唯一标识
         */
        function getGroupKey(names, ages) {
            return names.join(',') + '|' + ages.join(',');
        }

        // 电影与场次数据
        let movies = [];
        let currentMovieIdx = 0, currentSessionIdx = 0;

        /**
         * @description 保存当前场次座位信息到全局movies变量和localStorage
         */
        function saveCurrentSessionSeats() {
            if (movies.length === 0) return;
            const sessions = movies[currentMovieIdx]?.sessions;
            if (!sessions || sessions.length === 0) return;
            if (typeof sessions[currentSessionIdx] === 'undefined') return;
            // 深拷贝 seats 到当前场次
            sessions[currentSessionIdx].seats = JSON.parse(JSON.stringify(seats));
            // 同步到localStorage
            let allMovies = JSON.parse(localStorage.getItem('allMovies') || '[]');
            let m = allMovies.find(m => m.name === movies[currentMovieIdx].name);
            if (m && m.sessions && m.sessions[currentSessionIdx]) {
                m.sessions[currentSessionIdx].seats = JSON.parse(JSON.stringify(seats));
                localStorage.setItem('allMovies', JSON.stringify(allMovies));
            }
        }
        /**
         * @description 加载当前场次座位状态
         */
        function loadCurrentSessionSeats() {
            if (movies.length === 0) return;
            const sessions = movies[currentMovieIdx]?.sessions;
            if (!sessions || sessions.length === 0) return;
            if (typeof sessions[currentSessionIdx] === 'undefined') return;
            let session = sessions[currentSessionIdx];
            currentHall = session.hallSize;
            ROWS = HALL_CONFIG[currentHall].rows;
            COLS = HALL_CONFIG[currentHall].cols;
            // 动态调整canvas尺寸
            if (currentHall == 100) {
                canvas.width = 800;
                canvas.height = 550;
            } else if (currentHall == 200) {
                canvas.width = 1200;
                canvas.height = 590;
            } else if (currentHall == 300) {
                canvas.width = 1200;
                canvas.height = 800;
            }
            if (!session.seats) {
                // 首次进入该场次，初始化
                seats = Array.from({ length: ROWS }, (_, r) => Array.from({ length: COLS }, (_, c) => ({
                    status: 0,
                    row: r, col: c,
                    number: r * COLS + c + 1,
                    name: '',
                    age: null,
                    groupKey: '',
                    x: 0,
                    y: 0
                })));
                // 保存到session
                session.seats = JSON.parse(JSON.stringify(seats));
                // 同步到localStorage
                let allMovies = JSON.parse(localStorage.getItem('allMovies') || '[]');
                let m = allMovies.find(m => m.name === movies[currentMovieIdx].name);
                if (m && m.sessions && m.sessions[currentSessionIdx]) {
                    m.sessions[currentSessionIdx].seats = JSON.parse(JSON.stringify(seats));
                    localStorage.setItem('allMovies', JSON.stringify(allMovies));
                }
            } else {
                // 恢复
                seats = JSON.parse(JSON.stringify(session.seats));
            }
            selected = [];
        }

        /**
         * @description 切换电影时的处理函数
         */
        function onMovieChange() {
            saveCurrentSessionSeats(); // 保存上一个场次的座位
            currentMovieIdx = parseInt(document.getElementById('movieSelect').value);
            currentSessionIdx = 0; // 默认选中第一个场次
            renderSessionSelect(); // 重新渲染场次下拉框并加载新场次座位
        }
        /**
         * @description 切换场次时的处理函数
         */
        function onSessionChange() {
            saveCurrentSessionSeats();
            currentSessionIdx = parseInt(document.getElementById('sessionSelect').value);
            updateHallAndSeatsBySession();
            loadCurrentSessionSeats();
            drawSeats();
        }

        // 页面加载完成时的初始化函数
        window.onload = function () {
            // 从localStorage读取电影和场次数据
            let allMovies = JSON.parse(localStorage.getItem('allMovies') || '[]');
            // 从URL参数获取电影名，以实现从其他页面跳转过来时选中特定电影
            const urlParams = new URLSearchParams(window.location.search);
            const movieName = urlParams.get('movie');
            let movieIdx = 0;
            let sessionIdx = 0;
            movies = allMovies;
            if (movieName) {
                movieIdx = movies.findIndex(m => m.name === movieName);
                if (movieIdx === -1) movieIdx = 0; // 如果没找到，默认第一个
            }
            currentMovieIdx = movieIdx;
            currentSessionIdx = 0;
            // 渲染电影下拉框
            const movieSelect = document.getElementById('movieSelect');
            movieSelect.innerHTML = movies.map((m, i) => `<option value="${i}" ${i === movieIdx ? 'selected' : ''}>${m.name}</option>`).join('');

            // 渲染场次下拉框的函数
            function renderSessionSelect() {
                const sessions = movies[currentMovieIdx]?.sessions || [];
                const sessionSelect = document.getElementById('sessionSelect');
                sessionSelect.innerHTML = sessions.map((s, i) => `<option value="${i}">${s.date} ${s.start}~${s.end} (${s.hallSize}人厅${s.hallNo})</option>`).join('');
                currentSessionIdx = 0;
                if (sessions.length > 0) {
                    updateHallAndSeatsBySession();
                    loadCurrentSessionSeats();
                    drawSeats();
                }
            }
            window.renderSessionSelect = renderSessionSelect;
            // 绑定下拉框的onchange事件
            movieSelect.onchange = function () {
                onMovieChange();
            };
            document.getElementById('sessionSelect').onchange = function () {
                onSessionChange();
            };
            // 初始渲染
            renderSessionSelect();
        };
    </script>
</body>

</html>